#!/bin/bash
# i.e. apt-get install -y foo  or  bzr branch http://myserver/mycode /srv/webroot

set -ux

GAME=`config-get game`

apt-get install -y apache2

egrep  -i "^steam" /etc/passwd
if [ $? -ne 0 ]; then
	adduser --disabled-password --disabled-login --gecos "Valve,Steam Server,,,," steam
fi

install_steam() {
	mkdir -p /home/steam/hlds && cd $_

	wget "http://storefront.steampowered.com/download/hldsupdatetool.bin"
	chmod +x hldsupdatetool.bin
	yes "yes" | ./hldsupdatetool.bin

	mkdir -p /home/steam/www/replays
}

cp opt/$GAME-apache /etc/apache2/conf.d/
cp opt/steam /etc/init.d/ && chmod 0755 $_

chown -R steam.steam /home/steam

a2dissite default

mkdir -p /home/steam/hlds/server/orangebox/$GAME/cfg
cp opt/$GAME.cfg /home/steam/hlds/server/orangebox/$GAME/cfg/server.cfg

install_steam

open-port 80
open-port 27015
open-port 27016
